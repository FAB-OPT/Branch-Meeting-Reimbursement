<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏™‡∏≤‡∏Ç‡∏≤</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#1e3a8a;
      --bg2:#60a5fa;
      --card:#ffffff;
      --muted:#64748b;
      --line:#e5e7eb;
      --blue:#2563eb;
      --green:#16a34a;
      --red:#dc2626;
      --orange:#f97316;
      --soft:#f1f5f9;
      --shadow: 0 10px 30px rgba(0,0,0,.14);
      --radius: 22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Sarabun,system-ui,-apple-system,Segoe UI,Arial,sans-serif;
      background: linear-gradient(180deg,var(--bg1),var(--bg2));
      color:#0f172a;
    }
    .wrap{min-height:100%; display:flex; align-items:center; justify-content:center; padding:28px;}
    .card{
      width:min(980px, 100%);
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .login-card{
      width:min(560px, 100%);
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:28px;
      text-align:center;
    }
    .logos{display:flex; gap:14px; justify-content:center; align-items:center; margin:4px 0 10px;}
    .logos img{height:56px; width:auto; object-fit:contain;}
    h1{margin:6px 0 2px; font-size:26px; color:#1e3a8a}
    .sub{margin:0 0 18px; color:var(--muted); font-size:14px}
    .input{
      width:100%;
      height:46px;
      border:1px solid var(--line);
      background:#eef2ff;
      border-radius:12px;
      padding:0 14px;
      font-size:16px;
      outline:none;
    }
    .btn{
      border:0;
      height:46px;
      border-radius:12px;
      padding:0 16px;
      font-weight:700;
      font-size:16px;
      cursor:pointer;
    }
    .btn-primary{background:var(--blue); color:#fff; width:100%;}
    .btn-primary:hover{filter:brightness(.98)}
    .msg{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      font-size:14px;
      display:none;
    }
    .msg.err{display:block; background:#fee2e2; color:#7f1d1d; border:1px solid #fecaca;}
    .footer{margin-top:16px; font-size:12px; color:var(--muted)}
    /* app */
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding:16px 18px;
      background: #c7d2fe55;
      border-bottom:1px solid #dbeafe;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      font-weight:800; color:#1e293b;
    }
    .brand .icon{
      width:44px; height:44px; border-radius:14px;
      background:#2563eb15;
      display:grid; place-items:center;
    }
    .pill{
      border-radius:999px; padding:8px 12px; font-weight:700; font-size:13px;
      background:#1e3a8a; color:#fff;
    }
    .btn-danger{background:var(--red); color:#fff; height:40px; border-radius:999px; font-size:13px; padding:0 14px;}
    .content{padding:18px;}
    .timepill{
      margin:0 auto 12px;
      width:max-content;
      background:var(--green);
      color:#fff;
      border-radius:999px;
      padding:8px 14px;
      font-weight:800;
      font-size:13px;
    }
    .tabs{display:flex; gap:10px; margin:10px 0 14px;}
    .tab{flex:1; background:#f8fafc; border:1px solid var(--line); padding:10px 12px; border-radius:999px; font-weight:800; cursor:pointer; text-align:center;}
    .tab.active{background:#e0e7ff; border-color:#93c5fd;}
    .section{background:#fff; border:1px solid #e2e8f0; border-radius:18px; padding:14px;}
    .row{display:grid; grid-template-columns:1fr; gap:8px; margin-bottom:12px;}
    label{font-weight:800;}
    textarea.input{height:68px; padding:10px 14px; resize:vertical; background:#fff;}
    .hint{color:var(--muted); font-size:12px}
    .uploadBox{
      border:1px dashed #93c5fd;
      background:#eff6ff;
      border-radius:18px;
      padding:12px;
    }
    .uploadTop{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; align-items:center; margin-bottom:10px;}
    .miniBtn{height:40px; border-radius:14px; background:#fff; border:1px solid var(--line); font-weight:800; cursor:pointer;}
    .count{height:40px; border-radius:14px; background:#fff; border:1px solid var(--line); display:flex; align-items:center; justify-content:center; font-weight:900;}
    .thumbs{display:flex; gap:10px; flex-wrap:wrap; align-items:flex-start;}
    .thumb{
      width:78px; height:78px; border-radius:14px; border:1px solid #e2e8f0; overflow:hidden; position:relative; background:#fff; cursor:pointer;
    }
    .thumb img{width:100%; height:100%; object-fit:cover}
    .thumb .x{
      position:absolute; top:6px; right:6px;
      width:22px; height:22px; border-radius:999px;
      background:#0f172acc; color:#fff; display:grid; place-items:center; font-weight:900; font-size:14px;
    }
    .submitBar{display:flex; justify-content:center; margin-top:14px;}
    .btn-orange{background:var(--orange); color:#fff; width:min(520px,100%); height:48px; border-radius:14px; font-weight:900;}
    .list{display:grid; gap:10px;}
    .item{border:1px solid #e2e8f0; border-radius:16px; padding:12px; background:#fff;}
    .item .meta{display:flex; gap:10px; flex-wrap:wrap; color:var(--muted); font-size:12px}
    .doc{font-weight:900}
    .money{font-weight:900}
    .imgs{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .imgs a{font-size:12px}
    /* modal */
    .backdrop{
      position:fixed; inset:0; background:rgba(2,6,23,.55);
      display:none; align-items:center; justify-content:center; padding:18px;
      z-index:9999;
    }
    .modal{
      width:min(860px, 100%);
      background:#fff; border-radius:22px; overflow:hidden; box-shadow:var(--shadow);
    }
    .modalHead{display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-bottom:1px solid #e2e8f0; font-weight:900;}
    .modalBody{padding:14px 16px;}
    .modalFoot{padding:14px 16px; border-top:1px solid #e2e8f0; display:flex; gap:12px; justify-content:center;}
    .btn-red{background:var(--red); color:#fff; width:240px; height:44px; border-radius:14px; font-weight:900;}
    .btn-green{background:var(--green); color:#fff; width:240px; height:44px; border-radius:14px; font-weight:900;}
    .successBox{
      width:min(420px, 100%);
      background:#fff;
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:18px;
      text-align:center;
    }
    .check{
      width:56px;height:56px;border-radius:999px;background:#16a34a; color:#fff;
      display:grid; place-items:center; font-size:30px; margin:0 auto 8px; font-weight:900;
    }
    .okBtn{background:#16a34a;color:#fff;border:0;border-radius:14px;height:44px;width:160px;font-weight:900;cursor:pointer;margin-top:14px;}
    .docNo{font-size:20px;font-weight:900;margin-top:6px}
    .muted{color:var(--muted)}
    @media (max-width:720px){
      .uploadTop{grid-template-columns:1fr;}
      .btn-red,.btn-green{width:100%}
      .modalFoot{flex-direction:column;}
    }
  </style>
</head>
<body>
  <div class="wrap" id="wrapLogin">
    <div class="login-card">
      <div class="logos">
        <img alt="SantaFe" src="https://i.imgur.com/Tq8JYV9.png">
        <img alt="SantaFe Easy" src="https://i.imgur.com/Lz0jv2q.png">
        <img alt="Jaedang" src="https://i.imgur.com/1Gxe55O.png">
      </div>
      <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏™‡∏≤‡∏Ç‡∏≤</h1>
      <p class="sub">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠</p>
      <input id="loginCode" class="input" inputmode="numeric" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤ 4‚Äì6 ‡∏´‡∏•‡∏±‡∏Å" maxlength="6" />
      <div style="height:10px"></div>
      <button id="btnLogin" class="btn btn-primary">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      <div id="loginMsg" class="msg err"></div>
      <div class="footer">Prepared by Operations Department, FAB Food Holding<br>
        <span id="ver">Version 1.0 (22.1.2026) ‚Ä¢ BRIDGE_STABLE 2026-02-18</span>
      </div>
    </div>
  </div>

  <div class="wrap" id="wrapApp" style="display:none; align-items:flex-start;">
    <div class="card">
      <div class="topbar">
        <div class="brand">
          <div class="icon">üìÑ</div>
          <div>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏™‡∏≤‡∏Ç‡∏≤</div>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <div class="pill" id="pillBranch">-</div>
          <button class="btn btn-danger" id="btnLogout">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
      </div>

      <div class="content">
        <div class="timepill" id="timeNow">-</div>

        <div class="tabs">
          <div class="tab active" id="tabSend">‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</div>
          <div class="tab" id="tabHistory">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>
        </div>

        <div id="viewSend">
          <div class="row">
            <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å (‡∏ö‡∏≤‡∏ó)</label>
            <input id="amount" class="input" inputmode="decimal" placeholder="‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏Ç‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö" />
          </div>
          <div class="row">
            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</label>
            <input id="claimant" class="input" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" />
          </div>
          <div class="row">
            <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
            <textarea id="detail" class="input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏"></textarea>
          </div>

          <div class="row">
            <label>‡∏£‡∏π‡∏õ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3 ‡∏£‡∏π‡∏õ)</label>
            <div class="uploadBox">
              <div class="hint" style="text-align:center;margin-bottom:10px;">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö PNG/JPG ‚Ä¢ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB ‡∏ï‡πà‡∏≠‡∏£‡∏π‡∏õ</div>
              <div class="uploadTop">
                <button class="miniBtn" id="btnPick">üìé ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ</button>
                <button class="miniBtn" id="btnClear">‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ</button>
                <div class="count"><span id="imgCount">0</span>/3 ‡∏£‡∏π‡∏õ</div>
              </div>
              <input id="fileInput" type="file" accept="image/*" multiple style="display:none">
              <div class="thumbs" id="thumbs"></div>
            </div>
          </div>

          <div class="submitBar">
            <button class="btn btn-orange" id="btnReview">‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á</button>
          </div>
        </div>

        <div id="viewHistory" style="display:none;">
          <div class="section">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
              <div style="font-weight:900;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</div>
              <button class="miniBtn" id="btnReloadHistory">üîÑ ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà</button>
            </div>
            <div style="height:10px"></div>
            <div class="list" id="historyList"></div>
            <div class="hint" id="historyHint" style="margin-top:8px;"></div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Review Modal -->
  <div class="backdrop" id="bdReview">
    <div class="modal">
      <div class="modalHead">
        <div>‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</div>
        <button class="miniBtn" id="btnCloseReview" style="height:34px;border-radius:999px;padding:0 12px;">‡∏õ‡∏¥‡∏î</button>
      </div>
      <div class="modalBody">
        <div class="section" style="background:#f1f5f9;">
          <div style="font-weight:900;margin-bottom:8px;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á</div>
          <div class="meta" style="display:grid;grid-template-columns:120px 1fr;gap:6px 10px;font-size:13px;">
            <div class="muted">‡πÄ‡∏ß‡∏•‡∏≤</div><div id="rvTime">-</div>
            <div class="muted">‡∏™‡∏≤‡∏Ç‡∏≤</div><div id="rvBranch">-</div>
            <div class="muted">‡∏¢‡∏≠‡∏î</div><div id="rvAmount">-</div>
            <div class="muted">‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å</div><div id="rvClaimant">-</div>
            <div class="muted">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div><div id="rvDetail">-</div>
            <div class="muted">‡∏£‡∏π‡∏õ</div><div id="rvImgs" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
          </div>
        </div>
      </div>
      <div class="modalFoot">
        <button class="btn btn-red" id="btnBackEdit">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        <button class="btn btn-green" id="btnConfirmSend">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á</button>
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div class="backdrop" id="bdSuccess">
    <div class="successBox">
      <div class="check">‚úì</div>
      <div style="font-weight:900;font-size:20px;">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
      <div class="muted">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</div>
      <div style="height:12px"></div>
      <div class="muted" style="font-weight:800;">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</div>
      <div class="docNo" id="scDocNo">-</div>
      <button class="okBtn" id="btnOkSuccess">‡∏ï‡∏Å‡∏•‡∏á</button>
    </div>
  </div>

  <!-- Image Modal -->
  <div class="backdrop" id="bdImg">
    <div class="modal" style="max-width:920px;">
      <div class="modalHead">
        <div>‡∏î‡∏π‡∏£‡∏π‡∏õ</div>
        <button class="miniBtn" id="btnCloseImg" style="height:34px;border-radius:999px;padding:0 12px;">‡∏õ‡∏¥‡∏î</button>
      </div>
      <div class="modalBody" style="padding:0;background:#0b1220;">
        <img id="imgFull" alt="full" style="width:100%;max-height:80vh;object-fit:contain;display:block;">
      </div>
    </div>
  </div>

<script>
/** =========================
 * CONFIG
 * ========================= */
const API_EXEC = "PASTE_YOUR_GAS_WEBAPP_EXEC_URL_HERE"; // e.g. https://script.googleusercontent.com/macros/s/AKfy.../exec
const PARENT_ORIGIN = location.origin;

/** =========================
 * BRIDGE (iframe + postMessage)
 * ========================= */
let bridgeReady = false;
let bridgeFrame = null;
const pending = new Map();

function ensureBridge(){
  if(bridgeFrame) return;
  bridgeFrame = document.createElement('iframe');
  bridgeFrame.style.display = 'none';
  bridgeFrame.src = API_EXEC + (API_EXEC.includes('?') ? '&' : '?') + 'bridge=1';
  document.body.appendChild(bridgeFrame);

  window.addEventListener('message', (ev)=>{
    const msg = ev.data || {};
    if(!msg || msg.__BRIDGE__ !== 1) return;

    if(msg.ready){
      bridgeReady = true;
      return;
    }
    const id = msg.id;
    if(!pending.has(id)) return;
    const {resolve, reject} = pending.get(id);
    pending.delete(id);
    if(msg.ok) resolve(msg.res);
    else reject(new Error(msg.error || 'BRIDGE_ERROR'));
  }, false);
}

function run(fn, args, timeoutMs=15000){
  ensureBridge();
  return new Promise((resolve, reject)=>{
    const id = String(Date.now()) + "_" + Math.random().toString(16).slice(2);
    const t = setTimeout(()=>{
      if(pending.has(id)) pending.delete(id);
      reject(new Error("TIMEOUT"));
    }, timeoutMs);

    pending.set(id, {
      resolve: (v)=>{ clearTimeout(t); resolve(v); },
      reject: (e)=>{ clearTimeout(t); reject(e); },
    });

    // Wait until iframe exists; post anyway (it will queue once loaded in most browsers)
    bridgeFrame.contentWindow.postMessage({__BRIDGE__:1, id, fn, args}, PARENT_ORIGIN);
  });
}

/** =========================
 * STATE
 * ========================= */
const state = {
  role: null,
  branchCode: "",
  branchName: "",
  brand: "",
  districtManager: "",
  images: [] // dataUrls
};

function fmtMoney(n){
  const v = Number(n||0);
  return v.toLocaleString('th-TH',{minimumFractionDigits:2, maximumFractionDigits:2});
}
function nowText(){
  const d = new Date();
  return d.toLocaleString('th-TH',{
    year:'numeric',month:'long',day:'numeric',
    hour:'2-digit',minute:'2-digit',second:'2-digit'
  });
}

/** =========================
 * IMAGE HELPERS (NO 2-CLICK)
 * ========================= */
function fileToDataUrl(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = ()=> resolve(reader.result);
    reader.onerror = ()=> reject(new Error("READ_FAIL"));
    reader.readAsDataURL(file);
  });
}
function refreshThumbs(){
  const box = document.getElementById('thumbs');
  box.innerHTML = "";
  state.images.forEach((dataUrl, idx)=>{
    const div = document.createElement('div');
    div.className = 'thumb';
    div.innerHTML = `<img src="${dataUrl}"><div class="x" title="‡∏•‡∏ö">√ó</div>`;
    div.addEventListener('click', (e)=>{
      if(e.target && e.target.classList.contains('x')){
        e.stopPropagation();
        state.images.splice(idx,1);
        refreshThumbs();
        return;
      }
      openImg(dataUrl);
    });
    box.appendChild(div);
  });
  document.getElementById('imgCount').textContent = String(state.images.length);
}
async function handleFiles(files){
  const arr = Array.from(files||[]);
  for(const f of arr){
    if(state.images.length >= 3) break;
    if(!f.type || !f.type.startsWith('image/')) continue;
    // Limit 8MB hard (base64 grows)
    if(f.size > 8*1024*1024) continue;
    const dataUrl = await fileToDataUrl(f);
    state.images.push(dataUrl);
  }
  refreshThumbs();
}

/** =========================
 * UI WIRING
 * ========================= */
const $ = (id)=>document.getElementById(id);

function showLogin(errText=""){
  $('wrapLogin').style.display = 'flex';
  $('wrapApp').style.display = 'none';
  $('loginMsg').textContent = errText;
  $('loginMsg').style.display = errText ? 'block' : 'none';
}

function showApp(){
  $('wrapLogin').style.display = 'none';
  $('wrapApp').style.display = 'flex';
  $('pillBranch').textContent = `${state.branchName ? (state.branchName + " ‚Ä¢ ") : ""}${state.branchCode}`;
  $('timeNow').textContent = nowText();
}

function setTab(tab){
  const isSend = tab === 'send';
  $('tabSend').classList.toggle('active', isSend);
  $('tabHistory').classList.toggle('active', !isSend);
  $('viewSend').style.display = isSend ? 'block' : 'none';
  $('viewHistory').style.display = !isSend ? 'block' : 'none';
}

function openReview(){
  $('rvTime').textContent = nowText();
  $('rvBranch').textContent = `${state.branchName} (${state.branchCode})`;
  $('rvAmount').textContent = fmtMoney($('amount').value);
  $('rvClaimant').textContent = $('claimant').value || "-";
  $('rvDetail').textContent = $('detail').value || "-";
  const rvImgs = $('rvImgs');
  rvImgs.innerHTML = "";
  state.images.forEach((u)=>{
    const t = document.createElement('div');
    t.className = 'thumb';
    t.style.width='64px'; t.style.height='64px';
    t.innerHTML = `<img src="${u}">`;
    t.addEventListener('click', ()=>openImg(u));
    rvImgs.appendChild(t);
  });

  $('bdReview').style.display='flex';
}

function closeReview(){ $('bdReview').style.display='none'; }

function showSuccess(docNo){
  $('scDocNo').textContent = docNo || "-";
  $('bdSuccess').style.display='flex';
}

function closeSuccess(){ $('bdSuccess').style.display='none'; }

function openImg(url){
  $('imgFull').src = url;
  $('bdImg').style.display='flex';
}
function closeImg(){ $('bdImg').style.display='none'; $('imgFull').src=''; }

async function loadHistory(){
  $('historyHint').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
  $('historyList').innerHTML = '';
  try{
    const res = await run('apiListClaimsBranch', [state.branchCode, 200], 20000);
    if(!res || !res.ok){
      $('historyHint').textContent = '‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (res && res.error ? res.error : 'UNKNOWN');
      return;
    }
    const rows = res.rows || [];
    if(!rows.length){
      $('historyHint').textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
      return;
    }
    $('historyHint').textContent = `‡∏û‡∏ö ${rows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
    const list = $('historyList');
    rows.forEach((r)=>{
      const div = document.createElement('div');
      div.className='item';
      const imgs = (r.fileUrls||[]).map((u,i)=>`<a href="${u}" target="_blank">‡∏£‡∏π‡∏õ ${i+1}</a>`).join(' ‚Ä¢ ');
      div.innerHTML = `
        <div class="doc">${r.docNo || '-'}</div>
        <div class="meta">
          <div>${r.time || '-'}</div>
          <div>‡∏¢‡∏≠‡∏î: <span class="money">${fmtMoney(r.amount)}</span></div>
          <div>‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å: ${r.claimant || '-'}</div>
        </div>
        <div style="margin-top:6px;font-size:13px;">${(r.detail||'').replace(/</g,'&lt;')}</div>
        <div class="imgs">${imgs || ''}</div>
      `;
      list.appendChild(div);
    });
  }catch(e){
    $('historyHint').textContent = '‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.message;
  }
}

function resetForm(){
  $('amount').value='';
  $('claimant').value='';
  $('detail').value='';
  state.images = [];
  refreshThumbs();
}

async function submitClaim(){
  const amount = Number(String($('amount').value||'').replace(/,/g,''));
  const claimant = ($('claimant').value||'').trim();
  if(!amount || amount<=0){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô'); return; }
  if(!claimant){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å'); return; }

  const payload = {
    branchCode: state.branchCode,
    amount,
    claimant,
    detail: ($('detail').value||'').trim(),
    images: state.images.slice(0,3),
  };

  $('btnConfirmSend').disabled = true;
  $('btnConfirmSend').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';
  try{
    const res = await run('apiSubmitClaim', [payload], 45000);
    if(!res || !res.ok){
      alert('‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (res && (res.error||res.message) ? (res.error||res.message) : 'UNKNOWN'));
      return;
    }
    closeReview();
    showSuccess(res.docNo);
    resetForm();
  }catch(e){
    alert('‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.message);
  }finally{
    $('btnConfirmSend').disabled = false;
    $('btnConfirmSend').textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á';
  }
}

/** =========================
 * INIT
 * ========================= */
(function init(){
  // time ticker
  setInterval(()=>{ const el=$('timeNow'); if(el) el.textContent = nowText(); }, 1000);

  // Tabs
  $('tabSend').addEventListener('click', ()=>setTab('send'));
  $('tabHistory').addEventListener('click', ()=>{ setTab('history'); loadHistory(); });

  // Login
  $('btnLogin').addEventListener('click', async ()=>{
    const code = ($('loginCode').value||'').trim();
    showLogin('');
    if(!code){ showLogin('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤'); return; }

    $('btnLogin').disabled = true;
    $('btnLogin').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';
    try{
      const res = await run('apiLogin', [code], 20000);
      if(!res || !res.ok){
        showLogin('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        return;
      }
      state.role = res.role;
      state.branchCode = res.branchCode;
      state.branchName = res.branchName || '';
      state.brand = res.brand || '';
      state.districtManager = res.districtManager || '';
      showApp();
      setTab('send');
    }catch(e){
      showLogin('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.message);
    }finally{
      $('btnLogin').disabled = false;
      $('btnLogin').textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
    }
  });

  $('btnLogout').addEventListener('click', ()=>{
    state.role=null; state.branchCode=''; state.branchName='';
    resetForm();
    showLogin('');
  });

  // Upload
  $('btnPick').addEventListener('click', ()=> $('fileInput').click());
  $('fileInput').addEventListener('change', async (ev)=>{
    await handleFiles(ev.target.files);
    ev.target.value = ''; // allow re-pick same file
  });
  $('btnClear').addEventListener('click', ()=>{
    state.images=[]; refreshThumbs();
  });

  // Review / Send
  $('btnReview').addEventListener('click', openReview);
  $('btnCloseReview').addEventListener('click', closeReview);
  $('btnBackEdit').addEventListener('click', closeReview);
  $('btnConfirmSend').addEventListener('click', submitClaim);

  // Success
  $('btnOkSuccess').addEventListener('click', closeSuccess);

  // Img modal
  $('btnCloseImg').addEventListener('click', closeImg);
  $('bdImg').addEventListener('click', (e)=>{ if(e.target=== $('bdImg')) closeImg(); });

  // History reload
  $('btnReloadHistory').addEventListener('click', loadHistory);

  // Start
  showLogin('');
  refreshThumbs();

  // BRIDGE
  ensureBridge();
})();
</script>
</body>
</html>
