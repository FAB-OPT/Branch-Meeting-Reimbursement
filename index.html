<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏™‡∏≤‡∏Ç‡∏≤</title>

  <!-- Sarabun (required) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#2f67c8;
      --bg2:#5d86d8;
      --card:#ffffff;
      --muted:#6b7280;
      --text:#0f172a;
      --primary:#2563eb;
      --primary2:#1d4ed8;
      --danger:#ef4444;
      --warning:#f59e0b;
      --success:#16a34a;
      --line:#e5e7eb;
      --shadow:0 18px 50px rgba(15, 23, 42, .20);
      --radius:18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:"Sarabun", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color:var(--text);
      background: linear-gradient(160deg, var(--bg1), var(--bg2));
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }

    .wrap{
      width:min(980px, 100%);
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:18px;
      align-items:stretch;
    }
    @media (max-width: 860px){
      .wrap{ grid-template-columns: 1fr; }
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:22px 22px 18px;
      overflow:hidden;
    }

    .top-logos{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:22px;
      padding:10px 0 6px;
      flex-wrap:wrap;
    }
    .logo{
      height:46px;
      width:auto;
      object-fit:contain;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,.06));
    }
    .title{
      text-align:center;
      font-size:24px;
      font-weight:700;
      margin:8px 0 4px;
      color:#1f4aa5;
      letter-spacing:.2px;
    }
    .subtitle{
      text-align:center;
      font-size:14px;
      color:var(--muted);
      margin:0 0 16px;
    }

    .row{ display:flex; gap:10px; align-items:center; }
    .col{ display:flex; flex-direction:column; gap:8px; }
    .sp{ height:12px; }

    label{ font-size:13px; color:#334155; font-weight:600; }
    input, textarea, select{
      font-family:"Sarabun", sans-serif;
      font-size:15px;
      border:1px solid var(--line);
      border-radius:12px;
      padding:11px 12px;
      outline:none;
      background:#f8fafc;
      transition:.15s ease;
      width:100%;
    }
    input:focus, textarea:focus, select:focus{
      border-color:#93c5fd;
      box-shadow:0 0 0 4px rgba(59,130,246,.15);
      background:#fff;
    }
    textarea{ min-height:88px; resize:vertical; }

    .btn{
      border:0;
      background:var(--primary);
      color:#fff;
      padding:12px 14px;
      border-radius:12px;
      font-weight:700;
      font-size:15px;
      cursor:pointer;
      transition:.15s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      user-select:none;
    }
    .btn:hover{ background:var(--primary2); transform: translateY(-1px); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; transform:none; }

    .btn.ghost{
      background:transparent;
      border:1px solid var(--line);
      color:#0f172a;
    }
    .btn.ghost:hover{ background:#f1f5f9; transform:none; }

    .btn.danger{ background: var(--danger); }
    .btn.danger:hover{ filter: brightness(.95); }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background:#f1f5f9;
      color:#0f172a;
      font-size:13px;
      font-weight:700;
      border:1px solid var(--line);
    }
    .pill small{ color:var(--muted); font-weight:600; }

    .alert{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid;
      font-size:14px;
      line-height:1.35;
      margin-top:10px;
      display:none;
    }
    .alert.show{ display:block; }
    .alert.err{ background:#fff1f2; border-color:#fecdd3; color:#9f1239; }
    .alert.ok{ background:#ecfdf5; border-color:#bbf7d0; color:#065f46; }
    .alert.warn{ background:#fffbeb; border-color:#fde68a; color:#92400e; }

    .foot{
      text-align:center;
      color:#475569;
      font-size:12px;
      margin-top:16px;
    }

    .side h3{
      margin:0 0 10px;
      font-size:16px;
      color:#0f172a;
    }
    .kv{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .kpi{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:#fff;
    }
    .kpi .k{ font-size:12px; color:var(--muted); font-weight:700; }
    .kpi .v{ font-size:22px; font-weight:800; margin-top:2px; }

    .table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      background:#fff;
    }
    .table th, .table td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      font-size:13px;
      text-align:left;
      vertical-align:top;
    }
    .table th{
      background:#f8fafc;
      color:#334155;
      font-weight:800;
    }
    .table tr:hover td{ background:#f8fafc; cursor:pointer; }
    .badge{
      font-weight:800;
      font-size:12px;
      padding:5px 9px;
      border-radius:999px;
      display:inline-block;
      border:1px solid;
    }
    .b-pending{ background:#fffbeb; border-color:#fde68a; color:#92400e; }
    .b-done{ background:#ecfdf5; border-color:#bbf7d0; color:#065f46; }
    .b-reject{ background:#fff1f2; border-color:#fecdd3; color:#9f1239; }
    .b-other{ background:#eff6ff; border-color:#bfdbfe; color:#1d4ed8; }

    .imgs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .thumb{
      width:84px; height:84px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#f8fafc;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      position:relative;
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; }
    .thumb button{
      position:absolute;
      top:6px; right:6px;
      width:22px; height:22px;
      border-radius:999px;
      border:0;
      background:rgba(0,0,0,.55);
      color:#fff;
      cursor:pointer;
      font-weight:900;
      line-height:22px;
    }

    /* Modal */
    .modal-back{
      position:fixed;
      inset:0;
      background:rgba(2,6,23,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:22px;
      z-index:50;
    }
    .modal-back.show{ display:flex; }
    .modal{
      width:min(820px, 100%);
      background:#fff;
      border-radius:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modal-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px;
      background:#f8fafc;
      border-bottom:1px solid var(--line);
    }
    .modal-head b{ font-size:14px; }
    .modal-body{ padding:16px; }
    .modal-close{
      background:transparent;
      border:0;
      cursor:pointer;
      font-size:22px;
      line-height:1;
      padding:4px 8px;
    }
    .modal-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 860px){
      .modal-grid{ grid-template-columns: 1fr; }
    }

    .muted{ color:var(--muted); }
    .hr{ height:1px; background:var(--line); margin:12px 0; }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- MAIN -->
    <div class="card" id="mainCard">
      <div class="top-logos">
        <!-- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ -->
        <img class="logo" src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/3c/Logo-placeholder.svg/256px-Logo-placeholder.svg.png" alt="Logo 1">
        <img class="logo" src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/3c/Logo-placeholder.svg/256px-Logo-placeholder.svg.png" alt="Logo 2">
        <img class="logo" src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/3c/Logo-placeholder.svg/256px-Logo-placeholder.svg.png" alt="Logo 3">
      </div>

      <div class="title">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏™‡∏≤‡∏Ç‡∏≤</div>
      <div class="subtitle">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠</div>

      <!-- LOGIN -->
      <div id="loginView">
        <div class="col">
          <label>URL Web App (Apps Script /exec)</label>
          <input id="apiUrl" placeholder="‡∏ß‡∏≤‡∏á URL ‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ /exec ‡πÄ‡∏ä‡πà‡∏ô https://script.google.com/macros/s/....../exec" />
          <div class="row">
            <div style="flex:1">
              <label>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤ / ‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</label>
              <input id="loginCode" inputmode="numeric" placeholder="‡πÄ‡∏ä‡πà‡∏ô 601183 ‡∏´‡∏£‡∏∑‡∏≠ 5001" />
            </div>
            <div style="width: 160px; align-self:end;">
              <button class="btn" id="btnLogin">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
          </div>

          <div class="alert err" id="loginErr"></div>
          <div class="alert ok" id="loginOk"></div>

          <div class="foot">
            Prepared by Operations Department, FAB Food Holding<br/>
            <span class="muted" id="verText">Version 1.0</span>
          </div>
        </div>
      </div>

      <!-- APP -->
      <div id="appView" style="display:none;">
        <div class="row" style="justify-content:space-between; flex-wrap:wrap; gap:10px;">
          <div class="row" style="gap:10px; flex-wrap:wrap;">
            <span class="pill" id="pillUser">üë§ <span id="userName">-</span> <small id="userRole">-</small></span>
            <span class="pill">üóìÔ∏è <span id="cycleName">-</span></span>
          </div>
          <div class="row">
            <button class="btn ghost" id="btnReload">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
            <button class="btn ghost" id="btnLogout">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
          </div>
        </div>

        <div class="hr"></div>

        <!-- Branch panel -->
        <div id="branchPanel" style="display:none;">
          <h3 style="margin:0 0 10px;">‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</h3>

          <div class="modal-grid">
            <div class="col">
              <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å</label>
              <input id="claimantName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•" />

              <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
              <input id="amount" inputmode="decimal" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1200" />

              <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
              <textarea id="note" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>

              <label>‡∏£‡∏π‡∏õ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3 ‡∏£‡∏π‡∏õ) ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</label>
              <input id="imgInput" type="file" accept="image/*" multiple />

              <div class="imgs" id="imgPreview"></div>

              <div class="row" style="margin-top:8px;">
                <button class="btn" id="btnSubmit">‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</button>
                <button class="btn ghost" id="btnClearForm">‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
              </div>

              <div class="alert err" id="submitErr"></div>
              <div class="alert ok" id="submitOk"></div>
              <div class="alert warn" id="submitWarn"></div>
            </div>

            <div class="col">
              <h3 style="margin:0;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
              <div class="muted" style="font-size:13px;">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
              <table class="table" id="tblBranch">
                <thead>
                  <tr>
                    <th style="width:130px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á</th>
                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    <th style="width:120px; text-align:right;">‡∏¢‡∏≠‡∏î</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
              <div class="muted" id="branchMeta" style="font-size:12px; margin-top:6px;"></div>
            </div>
          </div>
        </div>

        <!-- Admin panel -->
        <div id="adminPanel" style="display:none;">
          <h3 style="margin:0 0 10px;">‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>

          <div class="kv">
            <div class="kpi"><div class="k">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</div><div class="v" id="kAll">0</div></div>
            <div class="kpi"><div class="k">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div><div class="v" id="kPending">0</div></div>
            <div class="kpi"><div class="k">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥/‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</div><div class="v" id="kDone">0</div></div>
            <div class="kpi"><div class="k">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥/‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</div><div class="v" id="kOther">0</div></div>
          </div>

          <div class="sp"></div>

          <div class="modal-grid">
            <div class="col">
              <label>‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</label>
              <div class="row">
                <select id="fStatus">
                  <option value="">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                  <option value="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                  <option value="‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
                  <option value="‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß">‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</option>
                  <option value="‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
                </select>
                <input id="fBranch" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)" />
              </div>

              <div class="row">
                <input id="fCycleKey" placeholder="cycleKey (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£) ‡πÄ‡∏ä‡πà‡∏ô 2026-02" />
                <button class="btn" id="btnFilter">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
              </div>

              <div class="alert err" id="adminErr"></div>
              <div class="alert ok" id="adminOk"></div>
            </div>

            <div class="col">
              <h3 style="margin:0;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å (CYCLE_MASTER)</h3>
              <div class="row">
                <button class="btn ghost" id="btnLoadCycles">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≠‡∏ö</button>
                <button class="btn ghost" id="btnGen12">‡∏™‡∏£‡πâ‡∏≤‡∏á 12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
                <button class="btn" id="btnSaveCycles">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≠‡∏ö</button>
              </div>
              <div class="muted" style="font-size:12px; margin-top:6px;">
                * ‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠/‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î‡πÑ‡∏î‡πâ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≠‡∏ö‚Äù
              </div>

              <div style="max-height:240px; overflow:auto; border:1px solid var(--line); border-radius:14px; margin-top:8px;">
                <table class="table" id="tblCycles" style="margin-top:0; border:0;">
                  <thead>
                    <tr>
                      <th style="width:110px;">cycleKey</th>
                      <th>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏ö</th>
                      <th style="width:120px;">‡πÄ‡∏£‡∏¥‡πà‡∏°</th>
                      <th style="width:120px;">‡∏à‡∏ö</th>
                      <th style="width:80px;">‡πÄ‡∏õ‡∏¥‡∏î</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="sp"></div>

          <table class="table" id="tblAdmin">
            <thead>
              <tr>
                <th style="width:150px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á</th>
                <th style="width:95px;">‡∏™‡∏≤‡∏Ç‡∏≤</th>
                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å</th>
                <th style="width:120px; text-align:right;">‡∏¢‡∏≠‡∏î</th>
                <th style="width:140px;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>

          <div class="muted" id="adminMeta" style="font-size:12px; margin-top:6px;"></div>
        </div>

      </div>
    </div>

    <!-- SIDE -->
    <div class="card side">
      <h3>‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡πÄ‡∏£‡πá‡∏ß ‚ú®</h3>
      <div class="muted" style="font-size:14px; line-height:1.5;">
        <b>1)</b> ‡∏ß‡∏≤‡∏á URL Web App (‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ <code>/exec</code>)<br/>
        <b>2)</b> ‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö 4‚Äì6 ‡∏´‡∏•‡∏±‡∏Å) ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô<br/>
        <b>3)</b> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏∂‡∏á ‚Äú‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‚Äù ‡∏à‡∏≤‡∏Å <code>CYCLE_MASTER</code><br/>
        <b>4)</b> ‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡πà‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏ö ‚Äú‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‚Äù ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô<br/><br/>
        <span class="muted">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</span> ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏ú‡πà‡∏≤‡∏ô JSONP ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß URL ‚Äî ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏à‡∏∞‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏†‡∏≤‡∏û‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏≤‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      </div>

      <div class="hr"></div>

      <h3>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ ‚úÖ</h3>
      <ul class="muted" style="margin:0; padding-left:18px; line-height:1.65;">
        <li>‡∏ï‡∏±‡πâ‡∏á <b>BRANCH_MASTER!A</b> ‡πÄ‡∏õ‡πá‡∏ô <b>Plain text</b></li>
        <li>‡πÉ‡∏ô <b>CYCLE_MASTER</b> ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô Date ‡∏à‡∏£‡∏¥‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö <b>dd/MM/yyyy</b></li>
        <li>Deploy Web App: Execute as <b>Me</b> ‡πÅ‡∏•‡∏∞ Access <b>Anyone with the link</b></li>
      </ul>
    </div>

  </div>

  <!-- Modal -->
  <div class="modal-back" id="modalBack">
    <div class="modal">
      <div class="modal-head">
        <b id="modalTitle">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</b>
        <button class="modal-close" id="modalClose">√ó</button>
      </div>
      <div class="modal-body">
        <div class="modal-grid">
          <div class="col">
            <div><b>ID:</b> <span id="mId" class="muted"></span></div>
            <div><b>‡∏™‡∏≤‡∏Ç‡∏≤:</b> <span id="mBranch" class="muted"></span></div>
            <div><b>‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å:</b> <span id="mName" class="muted"></span></div>
            <div><b>‡∏¢‡∏≠‡∏î:</b> <span id="mAmount" class="muted"></span></div>
            <div><b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</b> <span id="mStatus" class="muted"></span></div>
            <div><b>‡∏£‡∏≠‡∏ö:</b> <span id="mCycle" class="muted"></span></div>
            <div><b>‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á:</b> <span id="mSubmitted" class="muted"></span></div>
          </div>
          <div class="col">
            <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
            <textarea id="mNote" readonly></textarea>

            <div id="adminActions" style="display:none;">
              <label>‡πÅ‡∏Å‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)</label>
              <select id="mStatusSel">
                <option value="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                <option value="‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
                <option value="‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß">‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</option>
                <option value="‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
              </select>

              <div class="row">
                <button class="btn" id="btnUpdateStatus">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
                <button class="btn danger" id="btnDeleteClaim">‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
              </div>

              <div class="alert err" id="modalErr"></div>
              <div class="alert ok" id="modalOk"></div>
            </div>
          </div>
        </div>

        <div class="hr"></div>
        <div><b>‡∏£‡∏π‡∏õ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö:</b></div>
        <div class="imgs" id="mImgs"></div>
      </div>
    </div>
  </div>

<script>
/* =========================
   Utilities
========================= */
const $ = (id) => document.getElementById(id);
const LS = {
  apiUrl: 'MEETCLAIM_API_URL',
  lastCode: 'MEETCLAIM_LAST_CODE',
};

function setAlert(el, type, msg){
  el.className = 'alert ' + type + (msg ? ' show' : '');
  el.textContent = msg || '';
}

function canonCode(x){
  if (x === null || x === undefined) return '';
  let s = String(x).trim();
  if (/^\d+(\.0+)?$/.test(s)) s = s.replace(/\.0+$/, '');
  return s;
}

function b64EncodeUnicode(str){
  // UTF-8 safe base64
  const bytes = new TextEncoder().encode(str);
  let bin = '';
  bytes.forEach(b => bin += String.fromCharCode(b));
  return btoa(bin);
}

function jsonpCall(apiBase, fn, args){
  return new Promise((resolve) => {
    const cb = 'cb_' + Math.random().toString(16).slice(2);
    const urlBase = apiBase.replace(/\/+$/,'');
    const url = urlBase + '?fn=' + encodeURIComponent(fn)
      + '&args=' + encodeURIComponent(b64EncodeUnicode(JSON.stringify(args || [])))
      + '&callback=' + cb;

    // basic URL length guard
    if (url.length > 180000) {
      resolve({ ok:false, error:'URL_TOO_LONG', message:'‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏£‡∏π‡∏õ‡∏≠‡∏≤‡∏à‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô) ‡∏•‡∏≠‡∏á‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏π‡∏õ/‡∏†‡∏≤‡∏û‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á' });
      return;
    }

    const s = document.createElement('script');
    s.src = url;

    window[cb] = (data) => {
      try { resolve(data); }
      finally {
        try { delete window[cb]; } catch(e){}
        s.remove();
      }
    };

    s.onerror = () => {
      try { delete window[cb]; } catch(e){}
      s.remove();
      resolve({ ok:false, error:'NETWORK', message:'‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ï‡∏£‡∏ß‡∏à URL / Deploy / ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á)' });
    };

    document.body.appendChild(s);
  });
}

function badgeHtml(status){
  const s = String(status || '');
  if (s.includes('‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô')) return '<span class="badge b-pending">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>';
  if (s.includes('‡∏à‡πà‡∏≤‡∏¢') || s.includes('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥') || s.includes('‡πÄ‡∏™‡∏£‡πá‡∏à')) return `<span class="badge b-done">${escapeHtml(s)}</span>`;
  if (s.includes('‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥') || s.includes('‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò')) return `<span class="badge b-reject">${escapeHtml(s)}</span>`;
  if (!s) return '<span class="badge b-other">-</span>';
  return `<span class="badge b-other">${escapeHtml(s)}</span>`;
}

function fmtMoney(x){
  const n = Number(x);
  if (!isFinite(n)) return '-';
  return n.toLocaleString('th-TH') + ' ‡∏ö‡∏≤‡∏ó';
}

function escapeHtml(s){
  return String(s ?? '').replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));
}

/* =========================
   Image compression (client)
========================= */
async function fileToCompressedJpegBase64(file, maxW=1280, maxH=1280, quality=0.75){
  const dataUrl = await new Promise((res, rej)=>{
    const fr = new FileReader();
    fr.onload = () => res(fr.result);
    fr.onerror = rej;
    fr.readAsDataURL(file);
  });

  const img = await new Promise((res, rej)=>{
    const im = new Image();
    im.onload = () => res(im);
    im.onerror = rej;
    im.src = dataUrl;
  });

  const w0 = img.naturalWidth || img.width;
  const h0 = img.naturalHeight || img.height;
  let w = w0, h = h0;

  const scale = Math.min(1, maxW / w0, maxH / h0);
  w = Math.round(w0 * scale);
  h = Math.round(h0 * scale);

  const canvas = document.createElement('canvas');
  canvas.width = w;
  canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(img, 0, 0, w, h);

  const outUrl = canvas.toDataURL('image/jpeg', quality);
  const b64 = outUrl.split(',')[1] || '';
  return b64;
}

/* =========================
   State
========================= */
let STATE = {
  apiUrl: '',
  role: '',
  user: null,
  cycle: null,
  claims: [],
  images: [], // {name,mimeType,base64,previewUrl}
  lastOpenClaimId: null
};

function loadSettings(){
  const api = localStorage.getItem(LS.apiUrl) || '';
  const code = localStorage.getItem(LS.lastCode) || '';
  $('apiUrl').value = api;
  $('loginCode').value = code;
  $('verText').textContent = 'Version 1.0 (HTML)';
}
function saveSettings(){
  localStorage.setItem(LS.apiUrl, $('apiUrl').value.trim());
  localStorage.setItem(LS.lastCode, $('loginCode').value.trim());
}

/* =========================
   App flow
========================= */
async function login(){
  saveSettings();
  const apiUrl = $('apiUrl').value.trim();
  const code = canonCode($('loginCode').value);

  setAlert($('loginErr'),'err','');
  setAlert($('loginOk'),'ok','');

  if(!apiUrl || !apiUrl.includes('/exec')){
    setAlert($('loginErr'),'err','‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á URL Web App ‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ /exec');
    return;
  }
  if(!code){
    setAlert($('loginErr'),'err','‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô');
    return;
  }

  $('btnLogin').disabled = true;
  $('btnLogin').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';

  const res = await jsonpCall(apiUrl, 'apiLogin', [code]);

  $('btnLogin').disabled = false;
  $('btnLogin').textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';

  if(!res || !res.ok){
    const msg = (res && (res.message || res.detail || res.error)) ? (res.message || res.detail || res.error) : '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
    setAlert($('loginErr'),'err', msg);
    return;
  }

  STATE.apiUrl = apiUrl;
  STATE.role = res.role;
  STATE.user = res.user;

  setAlert($('loginOk'),'ok', '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ');

  $('loginView').style.display = 'none';
  $('appView').style.display = 'block';

  $('userName').textContent = res.user?.name || '-';
  $('userRole').textContent = res.role === 'admin' ? 'admin' : 'branch';

  await reloadAll();
}

async function reloadAll(){
  setAlert($('submitErr'),'err',''); setAlert($('submitOk'),'ok',''); setAlert($('submitWarn'),'warn','');
  setAlert($('adminErr'),'err',''); setAlert($('adminOk'),'ok','');

  // Cycle
  const cyc = await jsonpCall(STATE.apiUrl, 'apiGetCurrentCycle', []);
  if(cyc && cyc.ok){
    STATE.cycle = cyc.cycle || null;
    $('cycleName').textContent = STATE.cycle?.cycleName || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≠‡∏ö (‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤)';
  } else {
    STATE.cycle = null;
    $('cycleName').textContent = '‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
  }

  if(STATE.role === 'branch'){
    $('branchPanel').style.display = 'block';
    $('adminPanel').style.display = 'none';
    await loadClaimsBranch();
  } else {
    $('branchPanel').style.display = 'none';
    $('adminPanel').style.display = 'block';
    await loadClaimsAdmin();
  }
}

function logout(){
  STATE = { apiUrl:'', role:'', user:null, cycle:null, claims:[], images:[], lastOpenClaimId:null };
  $('appView').style.display = 'none';
  $('loginView').style.display = 'block';

  $('userName').textContent = '-';
  $('userRole').textContent = '-';
  $('cycleName').textContent = '-';

  clearForm(true);
}

function statusToBadgeClass(s){
  const t = String(s||'');
  if (t.includes('‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô')) return 'b-pending';
  if (t.includes('‡∏à‡πà‡∏≤‡∏¢') || t.includes('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥') || t.includes('‡πÄ‡∏™‡∏£‡πá‡∏à')) return 'b-done';
  if (t.includes('‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥') || t.includes('‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò')) return 'b-reject';
  return 'b-other';
}

/* =========================
   Claims: Branch
========================= */
async function loadClaimsBranch(){
  const code = canonCode(STATE.user?.branchCode || '');
  const res = await jsonpCall(STATE.apiUrl, 'apiListClaimsLite', ['branch', code, { limit: 200, offset: 0 }]);

  const tbody = $('tblBranch').querySelector('tbody');
  tbody.innerHTML = '';

  if(!res || !res.ok){
    $('branchMeta').textContent = '‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
    return;
  }

  STATE.claims = res.claims || [];
  $('branchMeta').textContent = `‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ ${res.meta?.returned ?? STATE.claims.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏™‡πÅ‡∏Å‡∏ô ${res.meta?.scannedRows ?? '-'} ‡πÅ‡∏ñ‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)`;

  STATE.claims.slice(0, 30).forEach(c=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(String(c.submittedAt||'').slice(0,19).replace('T',' '))}</td>
      <td>${badgeHtml(c.status)}</td>
      <td style="text-align:right;">${escapeHtml(fmtMoney(c.amount))}</td>
    `;
    tr.onclick = () => openClaim(c.id);
    tbody.appendChild(tr);
  });
}

/* =========================
   Claims: Admin
========================= */
async function loadClaimsAdmin(filters){
  const code = String(STATE.user?.adminCode || '').trim();
  const f = filters || {
    status: $('fStatus').value || '',
    branchCode: canonCode($('fBranch').value || ''),
    cycleKey: String($('fCycleKey').value || '').trim(),
    limit: 300,
    offset: 0
  };

  const res = await jsonpCall(STATE.apiUrl, 'apiListClaimsLite', ['admin', code, f]);

  const tbody = $('tblAdmin').querySelector('tbody');
  tbody.innerHTML = '';

  if(!res || !res.ok){
    const msg = (res && (res.message || res.detail || res.error)) ? (res.message || res.detail || res.error) : '‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
    setAlert($('adminErr'),'err', msg);
    return;
  }

  setAlert($('adminErr'),'err','');
  setAlert($('adminOk'),'ok','‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ');

  STATE.claims = res.claims || [];
  $('adminMeta').textContent = `‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ ${res.meta?.returned ?? STATE.claims.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏™‡πÅ‡∏Å‡∏ô ${res.meta?.scannedRows ?? '-'} ‡πÅ‡∏ñ‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)`;

  // KPI (‡∏à‡∏≤‡∏Å‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô‡∏°‡∏≤)
  const all = STATE.claims.length;
  const pending = STATE.claims.filter(x=>String(x.status||'').includes('‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô')).length;
  const done = STATE.claims.filter(x=>String(x.status||'').includes('‡∏à‡πà‡∏≤‡∏¢') || String(x.status||'').includes('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥') || String(x.status||'').includes('‡πÄ‡∏™‡∏£‡πá‡∏à')).length;
  const other = all - pending - done;

  $('kAll').textContent = all.toLocaleString('th-TH');
  $('kPending').textContent = pending.toLocaleString('th-TH');
  $('kDone').textContent = done.toLocaleString('th-TH');
  $('kOther').textContent = other.toLocaleString('th-TH');

  STATE.claims.forEach(c=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(String(c.submittedAt||'').slice(0,19).replace('T',' '))}</td>
      <td>${escapeHtml(c.branchCode || '')}</td>
      <td>${escapeHtml(c.claimantName || '')}</td>
      <td style="text-align:right;">${escapeHtml(fmtMoney(c.amount))}</td>
      <td>${badgeHtml(c.status)}</td>
    `;
    tr.onclick = () => openClaim(c.id);
    tbody.appendChild(tr);
  });
}

async function openClaim(id){
  $('modalBack').classList.add('show');
  setAlert($('modalErr'),'err',''); setAlert($('modalOk'),'ok','');
  $('mImgs').innerHTML = '';
  $('mNote').value = '';
  $('mStatusSel').value = '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';

  STATE.lastOpenClaimId = id;

  const mode = STATE.role === 'admin' ? 'admin' : 'branch';
  const requester = STATE.role === 'admin' ? String(STATE.user?.adminCode||'') : String(STATE.user?.branchCode||'');
  const res = await jsonpCall(STATE.apiUrl, 'apiGetClaimDetail', [mode, requester, id]);

  if(!res || !res.ok){
    setAlert($('modalErr'),'err', res?.message || res?.detail || res?.error || '‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    return;
  }

  const c = res.claim || {};
  $('modalTitle').textContent = '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
  $('mId').textContent = c.id || '';
  $('mBranch').textContent = (c.branchCode || '') + ' ' + (c.branchName ? '('+c.branchName+')' : '');
  $('mName').textContent = c.claimantName || '';
  $('mAmount').textContent = fmtMoney(c.amount);
  $('mStatus').textContent = c.status || '';
  $('mCycle').textContent = (c.cycleName || c.cycleKey || '');
  $('mSubmitted').textContent = String(c.submittedAt || '').slice(0,19).replace('T',' ');
  $('mNote').value = c.note || '';

  if(Array.isArray(c.imageUrls) && c.imageUrls.length){
    c.imageUrls.forEach(u=>{
      const div = document.createElement('div');
      div.className = 'thumb';
      const a = document.createElement('a');
      a.href = u;
      a.target = '_blank';
      a.rel = 'noopener';
      const im = document.createElement('img');
      im.src = u;
      a.appendChild(im);
      div.appendChild(a);
      $('mImgs').appendChild(div);
    });
  } else {
    $('mImgs').innerHTML = '<div class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ</div>';
  }

  if(STATE.role === 'admin'){
    $('adminActions').style.display = 'block';
    $('mStatusSel').value = c.status || '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
  } else {
    $('adminActions').style.display = 'none';
  }
}

function closeModal(){
  $('modalBack').classList.remove('show');
}

/* =========================
   Submit claim (branch)
========================= */
function renderImgPreview(){
  const wrap = $('imgPreview');
  wrap.innerHTML = '';
  STATE.images.forEach((it, idx)=>{
    const div = document.createElement('div');
    div.className = 'thumb';
    div.innerHTML = `<img src="${it.previewUrl}" alt="img">`;
    const btn = document.createElement('button');
    btn.textContent = '√ó';
    btn.onclick = () => {
      STATE.images.splice(idx,1);
      renderImgPreview();
    };
    div.appendChild(btn);
    wrap.appendChild(div);
  });
}

async function onPickImages(ev){
  const files = Array.from(ev.target.files || []);
  if(!files.length) return;

  // cap 3 images
  const remain = Math.max(0, 3 - STATE.images.length);
  if(remain <= 0){
    setAlert($('submitWarn'),'warn','‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3 ‡∏£‡∏π‡∏õ');
    ev.target.value = '';
    return;
  }
  const pick = files.slice(0, remain);

  setAlert($('submitWarn'),'warn','‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏£‡∏π‡∏õ...');
  for(const f of pick){
    const b64 = await fileToCompressedJpegBase64(f, 1280, 1280, 0.72);
    const previewUrl = 'data:image/jpeg;base64,' + b64;
    // guard: ‡∏ñ‡πâ‡∏≤‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô (‡∏Å‡∏±‡∏ô URL ‡∏¢‡∏≤‡∏ß)
    if (b64.length > 220000) {
      setAlert($('submitWarn'),'warn','‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÉ‡∏´‡∏ç‡πà (‡∏•‡∏≠‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏Å‡∏•‡πâ/‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)');
    }
    STATE.images.push({
      name: f.name || 'image.jpg',
      mimeType: 'image/jpeg',
      base64: b64,
      previewUrl
    });
  }
  setAlert($('submitWarn'),'warn','');
  renderImgPreview();
  ev.target.value = '';
}

function clearForm(silent=false){
  $('claimantName').value = '';
  $('amount').value = '';
  $('note').value = '';
  STATE.images = [];
  $('imgInput').value = '';
  renderImgPreview();
  if(!silent){
    setAlert($('submitErr'),'err','');
    setAlert($('submitOk'),'ok','‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
    setAlert($('submitWarn'),'warn','');
  }
}

async function submitClaim(){
  setAlert($('submitErr'),'err','');
  setAlert($('submitOk'),'ok','');
  setAlert($('submitWarn'),'warn','');

  const branchCode = canonCode(STATE.user?.branchCode || '');
  const claimantName = String($('claimantName').value || '').trim();
  const amount = Number(String($('amount').value || '').replace(/,/g,''));
  const note = String($('note').value || '').trim();

  if(!claimantName){
    setAlert($('submitErr'),'err','‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å');
    return;
  }
  if(!(amount > 0)){
    setAlert($('submitErr'),'err','‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
    return;
  }

  $('btnSubmit').disabled = true;
  $('btnSubmit').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';

  const payload = {
    branchCode,
    claimantName,
    amount,
    note,
    images: STATE.images.map(x=>({ name:x.name, mimeType:x.mimeType, base64:x.base64 }))
  };

  const res = await jsonpCall(STATE.apiUrl, 'apiSubmitClaim', [payload]);

  $('btnSubmit').disabled = false;
  $('btnSubmit').textContent = '‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£';

  if(!res || !res.ok){
    const msg = res?.message || res?.detail || res?.error || '‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
    setAlert($('submitErr'),'err', msg);
    return;
  }

  setAlert($('submitOk'),'ok', `‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ ID: ${res.claim?.id || '-'}`);
  clearForm(true);
  await loadClaimsBranch();
}

/* =========================
   Admin actions: Update / Delete
========================= */
async function updateStatus(){
  const id = STATE.lastOpenClaimId;
  if(!id) return;
  const newStatus = $('mStatusSel').value;
  const adminCode = String(STATE.user?.adminCode || '').trim();

  setAlert($('modalErr'),'err',''); setAlert($('modalOk'),'ok','');

  $('btnUpdateStatus').disabled = true;
  const res = await jsonpCall(STATE.apiUrl, 'apiUpdateClaim', [adminCode, id, { status: newStatus }]);
  $('btnUpdateStatus').disabled = false;

  if(!res || !res.ok){
    setAlert($('modalErr'),'err', res?.message || res?.detail || res?.error || '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    return;
  }
  setAlert($('modalOk'),'ok','‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
  await loadClaimsAdmin();
}

async function deleteClaim(){
  const id = STATE.lastOpenClaimId;
  if(!id) return;
  const adminCode = String(STATE.user?.adminCode || '').trim();
  if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ? (‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞)')) return;

  setAlert($('modalErr'),'err',''); setAlert($('modalOk'),'ok','');

  $('btnDeleteClaim').disabled = true;
  const res = await jsonpCall(STATE.apiUrl, 'apiDeleteClaim', [adminCode, id]);
  $('btnDeleteClaim').disabled = false;

  if(!res || !res.ok){
    setAlert($('modalErr'),'err', res?.message || res?.detail || res?.error || '‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    return;
  }

  setAlert($('modalOk'),'ok', `‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚úÖ (‡∏£‡∏π‡∏õ ${res.deletedFileCount ?? 0} ‡πÑ‡∏ü‡∏•‡πå)`);
  await loadClaimsAdmin();
  setTimeout(()=>closeModal(), 450);
}

/* =========================
   Admin: Cycle management UI
========================= */
function cycleRowTpl(c){
  const key = escapeHtml(c.cycleKey || '');
  const name = escapeHtml(c.cycleName || '');
  const sd = escapeHtml(c.startDate || '');
  const ed = escapeHtml(c.endDate || '');
  const open = !!c.isOpen;

  return `
    <tr>
      <td><input class="cy-key" value="${key}" readonly></td>
      <td><input class="cy-name" value="${name}"></td>
      <td><input class="cy-sd" value="${sd}" placeholder="yyyy-mm-dd ‡∏´‡∏£‡∏∑‡∏≠ dd/mm/yyyy"></td>
      <td><input class="cy-ed" value="${ed}" placeholder="yyyy-mm-dd ‡∏´‡∏£‡∏∑‡∏≠ dd/mm/yyyy"></td>
      <td style="text-align:center;"><input class="cy-open" type="checkbox" ${open ? 'checked':''}></td>
    </tr>
  `;
}

async function loadCycles(){
  const adminCode = String(STATE.user?.adminCode || '').trim();
  const res = await jsonpCall(STATE.apiUrl, 'apiListCycles', [adminCode]);
  if(!res || !res.ok){
    setAlert($('adminErr'),'err', res?.message || res?.detail || res?.error || '‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    return;
  }
  setAlert($('adminErr'),'err','');
  const tbody = $('tblCycles').querySelector('tbody');
  tbody.innerHTML = '';
  (res.cycles || []).forEach(c=>{
    const tr = document.createElement('tr');
    tr.innerHTML = cycleRowTpl(c);
    tbody.appendChild(tr);
  });
  setAlert($('adminOk'),'ok','‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
}

function readCyclesFromUI(){
  const rows = Array.from($('tblCycles').querySelectorAll('tbody tr'));
  return rows.map(r=>{
    const key = r.querySelector('.cy-key')?.value?.trim() || '';
    return {
      cycleKey: key,
      cycleName: r.querySelector('.cy-name')?.value?.trim() || key,
      startDate: r.querySelector('.cy-sd')?.value?.trim() || '',
      endDate: r.querySelector('.cy-ed')?.value?.trim() || '',
      isOpen: !!r.querySelector('.cy-open')?.checked,
      note: ''
    };
  }).filter(x=>x.cycleKey);
}

async function saveCycles(){
  const adminCode = String(STATE.user?.adminCode || '').trim();
  const cycles = readCyclesFromUI();
  const res = await jsonpCall(STATE.apiUrl, 'apiUpsertCycles', [adminCode, cycles]);
  if(!res || !res.ok){
    setAlert($('adminErr'),'err', res?.message || res?.detail || res?.error || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    return;
  }
  setAlert($('adminErr'),'err','');
  setAlert($('adminOk'),'ok','‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
  await reloadAll();
}

async function gen12(){
  const adminCode = String(STATE.user?.adminCode || '').trim();
  const res = await jsonpCall(STATE.apiUrl, 'apiGenerate12Months', [adminCode]);
  if(!res || !res.ok){
    setAlert($('adminErr'),'err', res?.message || res?.detail || res?.error || '‡∏™‡∏£‡πâ‡∏≤‡∏á 12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    return;
  }
  setAlert($('adminErr'),'err','');
  setAlert($('adminOk'),'ok', `‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° ${res.created ?? 0} ‡∏£‡∏≠‡∏ö ‚úÖ`);
  await loadCycles();
  await reloadAll();
}

/* =========================
   Events
========================= */
$('btnLogin').addEventListener('click', login);
$('btnLogout').addEventListener('click', logout);
$('btnReload').addEventListener('click', reloadAll);

$('imgInput').addEventListener('change', onPickImages);
$('btnClearForm').addEventListener('click', ()=>clearForm(false));
$('btnSubmit').addEventListener('click', submitClaim);

$('modalClose').addEventListener('click', closeModal);
$('modalBack').addEventListener('click', (e)=>{ if(e.target === $('modalBack')) closeModal(); });

$('btnUpdateStatus').addEventListener('click', updateStatus);
$('btnDeleteClaim').addEventListener('click', deleteClaim);

$('btnFilter').addEventListener('click', ()=>loadClaimsAdmin());
$('btnLoadCycles').addEventListener('click', loadCycles);
$('btnSaveCycles').addEventListener('click', saveCycles);
$('btnGen12').addEventListener('click', gen12);

// Enter key on login
$('loginCode').addEventListener('keydown', (e)=>{ if(e.key === 'Enter') login(); });

loadSettings();
</script>
</body>
</html>
